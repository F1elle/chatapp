services:
    postgres:
        image: postgres:17
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: pass
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 10s
            retries: 3
        volumes:
            - pgdata:/var/lib/postgresql/data
        networks:
            - chatapp-network
    rabbitmq:
        image: rabbitmq:3-management
        ports:
            - "5672:5672"       # AMQP
            - "15672:15672"     # Web UI
        environment:
            RABBITMQ_DEFAULT_USER: admin
            RABBITMQ_DEFAULT_PASS: admin123
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "status"]
            interval: 10s
            timeout: 10s
            retries: 3
        networks:
            - chatapp-network

    auth-service:
        extra_hosts:
            - "host.docker.internal:host-gateway"
        ports: # TODO: remove when expose api gateway
            - "8080:8080" 
            - "8081:8081"
        build:
            context: .
            dockerfile: src/ChatApp.Auth/Dockerfile
        environment:
            - ASPNETCORE_ENVIRONMENT=Docker
        depends_on:
            postgres:
                condition: service_healthy
                restart: true
            rabbitmq:
                condition: service_healthy
                restart: true
        networks:
            - chatapp-network
            

networks:
    chatapp-network:
        driver: bridge

volumes:
    pgdata:
